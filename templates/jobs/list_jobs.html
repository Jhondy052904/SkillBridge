{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Listings | SkillBridge</title>
    <link rel="stylesheet" href="{% static 'css/jobs/list_jobs.css' %}?v=5">
    <link rel="stylesheet" href="{% static 'css/registration/logout.css' %}?v=3">
</head>

<body>
<!-- ====================== NAVBAR ====================== -->
<nav class="navbar">
    <div class="nav-left">
        <a href="{% url 'home' %}" class="logo-link">
            <img src="/static/images/Skillogo.png" alt="Skill Bridge Logo" class="logo">
        </a>
    </div>

    <div class="nav-right">

        <!-- Main Navigation -->
        <a href="{% url 'home' %}">Dashboard</a>
        <a href="{% url 'list_jobs' %}" class="active">Jobs</a>
        <a href="{% url 'list_trainings' %}">Trainings</a>

        <!-- Underline Element for Animation -->
        <div class="underline"></div>

        <!-- Separator -->
        <span class="separator">|</span>

        <!-- Profile Link -->
        <a href="{% url 'edit_profile' %}">Profile</a>

        <!-- Logout -->
        <a href="{% url 'login' %}" id="logoutLink">Logout</a>

        <!-- Notifications -->
        {% include 'notification/notification.html' %}

    </div>
</nav>


<!-- ====================== MAIN ====================== -->
<main>

    <!-- Messages -->
    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
            <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-error{% else %}alert-info{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Header Section -->
    <div class="header-section">
        <h1 class="section-title">Hello {{ user.first_name }}! Ready to land a new job?</h1>
        <p class="section-subtitle">Explore open positions and apply now.</p>
    </div>

    <!-- Search & Filter Section -->
    <div class="search-filter-section">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search jobs by title, company...">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        </div>

        <div class="filter-container">
            <select id="filterSelect">
                <option value="other" selected>Other</option>
                <option value="Haircut">Haircut</option>
                <option value="Plumbing">Plumbing</option>
                <option value="Electrical">Electrical</option>
                <option value="Carpentry">Carpentry</option>
                <option value="Cleaning">Cleaning</option>
                <option value="Cooking">Cooking</option>
                <option value="Driving">Driving</option>
                <option value="Babysitting">Babysitting</option>
                <option value="Elderly Care">Elderly Care</option>
                <option value="Tutoring">Tutoring</option>
                <option value="Pedicure">Pedicure</option>
            </select>
        </div>

        <button class="btn-search" onclick="filterJobs()">Search</button>
    </div>

    <!-- Job Listings Section -->
    <section class="jobs-section">
        <h2 class="section-title">Available Jobs</h2>

        <div id="jobList" class="job-cards-container">
            {% for job in jobs %}
                {% if job.Status == "Open" %}
                <a href="{% url 'job_detail' job.JobID %}" class="job-card-link">
                    <div class="job-card">
                        

                        <div class="job-card-content">
                            <h3 class="job-title">{{ job.Title }}</h3>
                                <div class="card-header">
                            <div class="job-status-badge {% if job.Status == 'Open' %}status-open{% else %}status-closed{% endif %}">{{ job.Status }}</div>
                        </div>
                            {% if job.skills %}
                            <div class="job-skills">
                                {% for skill in job.skills %}
                                    <span class="skill-tag">{{ skill }}</span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="job-skills">
                                <span class="skill-tag no-skills">No specific skills required</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% endif %}
            {% empty %}
                <div class="empty-state">
                    <p>No job postings available at the moment.</p>
                    <p class="empty-state-secondary">Check back soon for new opportunities!</p>
                </div>
            {% endfor %}
        </div>
    </section>

</main>

<!-- =============== DATA FOR JS =============== -->
<script>
const jobData = [
    {% for job in jobs %}
        {% if job.Status == "Open" %}
        { title: "{{ job.Title|escapejs }}", start: "{{ job.dateposted|date:'Y-m-d' }}" }{% if not forloop.last %},{% endif %}
        {% endif %}
    {% endfor %}
];

const counts = {
    users: {{ user_count|default:0 }},
    jobs: {{ job_count|default:0 }},
    applications: {{ application_count|default:0 }}
};

// Filter Jobs Function
function filterJobs() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const selectedSkill = document.getElementById('filterSelect').value.toLowerCase();
    const jobCards = document.querySelectorAll('.job-card-link');

    jobCards.forEach(card => {
        const title = card.querySelector('.job-title').textContent.toLowerCase();
        const skills = Array.from(card.querySelectorAll('.skill-tag')).map(tag => tag.textContent.toLowerCase()).join(' ');

        const matchesSearch = title.includes(searchTerm);
        const matchesSkill = !selectedSkill || selectedSkill === 'other' || skills.includes(selectedSkill);

        if (matchesSearch && matchesSkill) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

// Allow filtering on Enter key
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') filterJobs();
        });
    }
});

// Apply for Job Function
function applyForJob(jobId) {
    if (confirm('Are you sure you want to apply for this job?')) {
        // Submit the application
        fetch(`/jobs/${jobId}/apply/`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Application submitted successfully!');
                } else {
                    alert('Failed to submit application');
                }
            })
            .catch(error => console.error('Error:', error));
    }
}

// Navbar underline animation
const menuLinks = document.querySelectorAll('.nav-right a');
const underline = document.querySelector('.nav-right .underline');

function moveUnderline(el) {
    if (!underline) return;
    const rect = el.getBoundingClientRect();
    const parentRect = el.closest('.nav-right').getBoundingClientRect();
    underline.style.width = rect.width + 'px';
    underline.style.left = (rect.left - parentRect.left) + 'px';
}

const activeLink = document.querySelector('.nav-right a.active');
if (activeLink) {
    setTimeout(() => moveUnderline(activeLink), 0);
}

menuLinks.forEach(link => {
    link.addEventListener('mouseenter', e => {
        if (e.target.tagName === 'A') moveUnderline(e.target);
    });
});

document.querySelector('.nav-right').addEventListener('mouseleave', () => {
    if (activeLink) moveUnderline(activeLink);
});

// Logout popup
const logoutLink = document.getElementById('logoutLink');
if (logoutLink) {
    logoutLink.addEventListener('click', function(e) {
        e.preventDefault();

        const popup = document.createElement('div');
        popup.className = 'logout-popup';
        popup.innerHTML = `
            <p>Are you sure you want to end your session?</p>
            <div class="separator"></div>
            <div class="popup-buttons">
                <button id="cancelLogout">Cancel</button>
                <button id="confirmLogout">Yes</button>
            </div>
        `;
        document.body.appendChild(popup);

        document.getElementById('confirmLogout').addEventListener('click', () => {
            window.location.href = logoutLink.href;
        });

        document.getElementById('cancelLogout').addEventListener('click', () => {
            popup.classList.add('fade-out');
            setTimeout(() => popup.remove(), 300);
        });
    });
}
</script>

</body>
</html>