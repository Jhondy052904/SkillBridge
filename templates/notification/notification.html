{% load static %}

<!-- Notification Button -->
<div class="notifications">
    <button onclick="toggleNotifDropdown()" id="notifBtn" class="notif-btn">
        <img src="{% static 'images/notif.png' %}" alt="Notifications" class="notif-icon">
        {% if notifications %}
            <span class="notif-indicator">{{ notifications|length }}</span>
        {% endif %}
    </button>

    <div id="notifDropdown" class="notif-dropdown hidden">
        {% if notifications %}
            {% for notif in notifications %}
            <div onclick="handleNotificationClick('{{ notif.link_url|escapejs }}')" class="notif-item" data-link-url="{{ notif.link_url|escapejs }}">
                <p class="notif-message">{{ notif.message }}</p>
                <small class="notif-date">{{ notif.created_at|date:"M d, Y h:i A" }}</small>
            </div>
            {% endfor %}
            <form method="POST" action="{% url 'clear_notifications' %}">
                {% csrf_token %}
                <button type="submit" class="notif-clear-btn">Clear All</button>
            </form>
        {% else %}
            <p class="notif-empty">No notifications.</p>
        {% endif %}
    </div>
</div>

<style>

.notifications { position: relative; display: inline-block; }
.notif-btn { height:40px;width:40px;border:none;background:none;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.notif-btn img { width:80%;height:80%;object-fit:contain;pointer-events:none; }
.notif-indicator { display:inline-block; min-width:20px;height:20px;padding:0 6px;background:#dc3545;color:#fff;font-size:12px;font-weight:bold;text-align:center;border-radius:50%;line-height:20px;vertical-align:middle;}
.notif-dropdown { position:absolute; top:50px; right:0; width:340px; max-height:420px; overflow-y:auto; background:#EBF4F6; border-radius:20px; box-shadow:0 12px 40px rgba(66,153,225,0.2); padding:16px 0; z-index:1000;}
.notif-item { padding:18px 24px; border-bottom:1px solid rgba(226,232,240,0.8); cursor:pointer; transition:all 0.2s ease;}
.notif-item:last-child {border-bottom:none;}
.notif-item:hover { background: rgba(66,153,225,0.05);}
.notif-message { font-size:0.95rem;color:#2D3748;margin-bottom:6px;font-weight:500;line-height:1.5;}
.notif-date { font-size:0.85rem;color:#718096;}
.notif-clear-btn { width:100%;padding:14px 0;background:linear-gradient(135deg,#4299E1,#63B3ED);color:#fff;border:none;border-radius:0 0 20px 20px;cursor:pointer;font-weight:600;font-size:0.95rem;transition:all 0.2s ease;}
.notif-clear-btn:hover { background:linear-gradient(135deg,#3182CE,#4299E1);}
.notif-empty { text-align:center; padding:40px 24px; color:#A0AEC0; font-style:italic; font-size:0.95rem;}
.hidden { display:none !important; }

/* Toast notifications */
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
}

.toast-success { background: #4CAF50; }
.toast-info { background: #2196F3; }
.toast-warning { background: #FF9800; }
.toast-error { background: #F44336; }

.toast-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.toast-content button {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    margin-left: 10px;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
</style>

<script>
const notifBtn = document.getElementById('notifBtn');
const notifDropdown = document.getElementById('notifDropdown');

function toggleNotifDropdown() {
    notifDropdown.classList.toggle('hidden');
}

function handleNotificationClick(linkUrl) {
    // Check if user is authenticated by making a quick API call
    fetch('/notifications/latest/')
        .then(response => {
            if (response.status === 401) {
                // User is not authenticated, redirect to login
                window.location.href = '{% url "login" %}?next=' + encodeURIComponent(linkUrl);
                return false;
            }
            // User is authenticated, proceed with navigation
            window.location.href = linkUrl;
        })
        .catch(error => {
            console.error('Authentication check failed:', error);
            // In case of network error, still try to navigate
            // But first check if we're likely authenticated by checking Django's auth state
            if (typeof window.djangoAuth !== 'undefined' && !window.djangoAuth.isAuthenticated) {
                window.location.href = '{% url "login" %}?next=' + encodeURIComponent(linkUrl);
            } else {
                window.location.href = linkUrl;
            }
        });
}

// Click outside to close
document.addEventListener('click', (e) => {
    if (!notifDropdown.contains(e.target) && !notifBtn.contains(e.target)) {
        notifDropdown.classList.add('hidden');
    }
});

// Escape key to close
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') notifDropdown.classList.add('hidden');
});

// In-app toast alerts for new notifications
{% if notifications %}
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()">Ã—</button>
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

// Show toast for new notifications on page load
document.addEventListener('DOMContentLoaded', () => {
    {% for notif in notifications %}
        showToast('{{ notif.message|escapejs }}', 'success');
    {% endfor %}

    // Start polling for new notifications
    setInterval(checkForNewNotifications, 30000); // Check every 30 seconds
});

let lastNotificationId = {% if notifications %}{{ notifications.0.id }}{% else %}null{% endif %};

function checkForNewNotifications() {
    fetch('/notifications/latest/')
        .then(response => response.json())
        .then(data => {
            if (data.has && data.notification.id !== lastNotificationId) {
                // New notification
                lastNotificationId = data.notification.id;
                showToast(data.notification.message, 'info');
                // Update the notification count and dropdown
                updateNotificationUI(data.notification);
            }
        })
        .catch(error => console.error('Error checking notifications:', error));
}

function updateNotificationUI(notification) {
    const notifBtn = document.getElementById('notifBtn');
    const notifDropdown = document.getElementById('notifDropdown');

    // Update count
    let indicator = notifBtn.querySelector('.notif-indicator');
    if (!indicator) {
        indicator = document.createElement('span');
        indicator.className = 'notif-indicator';
        notifBtn.appendChild(indicator);
    }
    const currentCount = parseInt(indicator.textContent) || 0;
    indicator.textContent = currentCount + 1;

    // Add to dropdown
    const notifItem = document.createElement('div');
    notifItem.className = 'notif-item';
    notifItem.onclick = () => handleNotificationClick(notification.link_url);
    notifItem.innerHTML = `
        <p class="notif-message">${notification.message}</p>
        <small class="notif-date">${new Date(notification.created_at).toLocaleDateString()}</small>
    `;
    notifDropdown.insertBefore(notifItem, notifDropdown.querySelector('.notif-clear-btn').parentElement);
}
{% endif %}
</script>
