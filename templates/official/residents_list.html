{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Residents List | SkillBridge</title>

    <link rel="stylesheet" href="{% static 'css/official/residents_list.css' %}?v=1">
</head>

<body>

<a href="{% url 'official_dashboard' %}" class="back-btn">
    â†© Back
</a>

    <!-- ================== MAIN ================== -->
    <main class="main-container">

        <header class="header-top">
            <h1 class="page-title">Residents List</h1>
        </header>

        <!-- ================== Search ================== -->
        <form method="get" class="search-form">
            <input type="text" name="search" placeholder="Search by name..." value="{{ request.GET.search }}" class="search-input">
            <button type="submit" class="btn-search">Search</button>
        </form>

        <!-- ================== Status & Messages ================== -->
        {% if messages %}
        <div class="message-container">
            {% for message in messages %}
            <div class="message-item {% if message.tags == 'success' %}message-success{% elif message.tags == 'error' %}message-error{% else %}message-info{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- ================= RESIDENTS LIST ================= -->
        <section class="residents-section">
            {% if residents %}
            <div class="resident-list">
                {% for resident in residents %}
                <div class="resident-card">
                    <div class="resident-info">
                        <a href="#" class="open-resident-modal" data-resident-id="{{ resident.id }}">
                            <h3 class="resident-name">Name: {{ resident.first_name }} {{ resident.last_name }}</h3>
                        </a>
                        <p class="resident-status">Status: 
                            <span class="{% if resident.current_status == 'Hired' %}status-hired{% elif resident.current_status == 'Training' %}status-training{% else %}status-pending{% endif %}">
                                {{ resident.current_status }}
                            </span>
                        </p>
                    </div>

                    <form method="post" class="resident-action">
                        {% csrf_token %}
                        <input type="hidden" name="resident_id" value="{{ resident.id }}">
                        <button type="submit" class="btn-deactivate" onclick="return confirm('Are you sure you want to deactivate this resident?')">
                            Deactivate
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
                <p class="no-residents">No residents found.</p>
            {% endif %}
        </section>

    </main>

<div id="residentModal" class="modal hidden">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div id="modalDetails">Loading...</div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("residentModal");
    const modalDetails = document.getElementById("modalDetails");

    document.querySelectorAll('.open-resident-modal').forEach(link => {
        link.addEventListener('click', async (e) => {
            e.preventDefault();
            const residentId = link.dataset.residentId;

            try {
                const res = await fetch(`/official/resident/${residentId}/details/`);
                if (res.ok) {
                    const html = await res.text();
                    modalDetails.innerHTML = html; 
                    modal.classList.remove("hidden");
                } else {
                    alert('Resident details not found');
                }
            } catch (err) {
                console.error(err);
                alert('Error fetching resident details');
            }
        });
    });

    // Close modal
    document.querySelector(".close-modal").onclick = () => {
        modal.classList.add("hidden");
    };

    // Close modal on clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.add("hidden");
        }
    });
});


</script>

</body>
</html>
