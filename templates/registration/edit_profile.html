{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Profile | SkillBridge</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{% static 'css/registration/editprofile.css' %}?v=6">
  <link rel="stylesheet" href="{% static 'css/registration/logout.css' %}?v=3">
</head>

<body>

<nav class="navbar">
    <div class="nav-left">
        <a href="{% url 'home' %}" class="logo-link">
            <img src="/static/images/Skillogo.png" alt="Skill Bridge Logo" class="logo">
        </a>
    </div>

    <div class="nav-right">
        <a href="{% url 'home' %}">Dashboard</a>
        <a href="{% url 'list_jobs' %}">Jobs</a>
        <a href="{% url 'list_trainings' %}">Trainings</a>

        <div class="underline"></div>
        <span class="separator">|</span>
        <a href="{% url 'edit_profile' %}" class="active">Profile</a>
        <a href="{% url 'login' %}" id="logoutLink">Logout</a>

<!-- Notifications -->
<div class="notifications">
    <button onclick="toggleNotifDropdown()" id="notifBtn" class="notif-btn">
        <img src="/static/images/notif.png" alt="Notifications" class="notif-icon">

        {% if notifications %}
            <span class="notif-indicator"></span>
        {% endif %}
    </button>

    <!-- DROPDOWN -->
    <div id="notifDropdown" class="notif-dropdown hidden">
        {% if notifications %}
            {% for notif in notifications %}
            <div onclick="window.location.href='{{ notif.link_url }}'" class="notif-item">
                <p class="notif-message">{{ notif.message }}</p>
                <small class="notif-date">{{ notif.created_at|date:"M d, Y h:i A" }}</small>
            </div>
            {% endfor %}
            <form method="POST" action="{% url 'clear_notifications' %}">
                {% csrf_token %}
                <button type="submit" class="notif-clear-btn">Clear All</button>
            </form>
        {% else %}
            <p class="notif-empty">No notifications.</p>
        {% endif %}
    </div>
</div>

    </div>
</nav>

{% if messages %}
  {% for message in messages %}
    <div class="editprofile-message 
        {% if message.tags == 'success' %}success
        {% elif message.tags == 'error' %}error
        {% else %}info
        {% endif %}">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}

<main class="main-content">
  <section class="editprofile-page">

    <div class="profile-card editprofile-card">
      <h1 class="editprofile-title">Edit Profile</h1>

      <form method="POST" class="editprofile-form">
        {% csrf_token %}

        <!-- BASIC FIELDS -->
        <div class="field-group">
          <label>First Name</label>
          <input type="text" name="first_name" value="{{ form.first_name.value|default:'' }}" required>
        </div>

        <div class="field-group">
          <label>Middle Name</label>
          <input type="text" name="middle_name" value="{{ form.middle_name.value|default:'' }}">
        </div>

        <div class="field-group">
          <label>Last Name</label>
          <input type="text" name="last_name" value="{{ form.last_name.value|default:'' }}" required>
        </div>

        <div class="field-group">
          <label>Address</label>
          <input type="text" name="address" value="{{ form.address.value|default:'' }}">
        </div>

        <div class="field-group">
          <label>Contact Number</label>
          <input type="text" name="contact_number" value="{{ form.contact_number.value|default:'' }}">
        </div>

        <div class="field-group">
          <label>Employment Status</label>
          <select name="employment_status">
            {% for value, label in form.fields.employment_status.choices %}
              <option value="{{ value }}" {% if form.employment_status.value == value %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- SKILLS MULTISELECT -->
        <div class="field-group">
          <label>Skills</label>

          <div class="tag-multiselect" id="tagSelect">

            <div class="tags-container" id="selectedTags">
              {% for skill in all_skills %}
                {% if skill.id|stringformat:"s" in selected_skill_ids %}
                  <div class="tag" data-id="{{ skill.id }}">
                    {{ skill.skill_name }}
                    <span class="remove-tag" onclick="removeTag('{{ skill.id }}', this)">×</span>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
            
              <div id="skillOptions" class="options-list">
                  {% for skill in all_skills %}
                    <div 
                      class="option-item {% if skill.id|stringformat:'s' in selected_skill_ids %}hidden{% endif %}"
                      data-id="{{ skill.id }}"
                      data-name="{{ skill.skill_name }}"
                      onclick="addTag('{{ skill.id }}', '{{ skill.skill_name }}')"
                    >
                      {{ skill.skill_name }}
                    </div>
                  {% endfor %}
              </div>
          </div>

          <div id="hiddenInputs">
              {% for skill_id in selected_skill_ids %}
                <input type="hidden" name="skills" value="{{ skill_id }}">
              {% endfor %}
          </div>
        </div>

        <div class="field-group">
          <label>Current Status</label>
          <select name="current_status">
            {% for value, label in form.fields.current_status.choices %}
              <option value="{{ value }}" {% if form.current_status.value == value %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
        </div>

        <button type="submit" class="editprofile-submit">Save Changes</button>
      </form>
    </div>

  </section>
</main>

<!-- ===================== JS ===================== -->
<script>
// Navbar underline animation
const menuLinks = document.querySelectorAll('.nav-right a');
const underline = document.querySelector('.nav-right .underline');

function moveUnderline(el) {
    if (!underline) return;
    const rect = el.getBoundingClientRect();
    const parentRect = el.closest('.nav-right').getBoundingClientRect();
    underline.style.width = rect.width + 'px';
    underline.style.left = (rect.left - parentRect.left) + 'px';
}

const activeLink = document.querySelector('.nav-right a.active');
if (activeLink) {
    setTimeout(() => moveUnderline(activeLink), 0);
}

menuLinks.forEach(link => {
    link.addEventListener('mouseenter', e => {
        if (e.target.tagName === 'A') moveUnderline(e.target);
    });
});

document.querySelector('.nav-right').addEventListener('mouseleave', () => {
    if (activeLink) moveUnderline(activeLink);
});

//Notif
const notifBtn = document.getElementById('notifBtn');
const notifDropdown = document.getElementById('notifDropdown');

function toggleNotifDropdown() {
    notifDropdown.classList.toggle('hidden');
}
  /* ---------------- TAG MULTISELECT ---------------- */
  function addTag(id, name) {
      const tags = document.getElementById("selectedTags");
      const hidden = document.getElementById("hiddenInputs");

      // Create tag element
      const tagEl = document.createElement("div");
      tagEl.className = "tag";
      tagEl.setAttribute("data-id", id);
      tagEl.innerHTML = `${name} <span class="remove-tag" onclick="removeTag('${id}', this)">×</span>`;
      tags.appendChild(tagEl);

      // Create hidden input
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "skills";
      input.value = id;
      hidden.appendChild(input);

      // Hide option from dropdown
      document.querySelector(`.option-item[data-id='${id}']`).classList.add("hidden");
  }

  function removeTag(id, el) {
      // Remove tag UI
      el.parentElement.remove();

      // Show option back
      const opt = document.querySelector(`.option-item[data-id='${id}']`);
      if (opt) opt.classList.remove("hidden");

      // Remove hidden input
      const hidden = document.querySelector(`#hiddenInputs input[value='${id}']`);
      if (hidden) hidden.remove();
  }


  /* ---------------- LOGOUT POPUP ---------------- */
  const logoutLink = document.getElementById('logoutLink');

  if (logoutLink) {
    logoutLink.addEventListener('click', function(e) {
        e.preventDefault();

        const popup = document.createElement('div');
        popup.className = 'logout-popup';
        popup.innerHTML = `
            <p>Are you sure you want to end your session?</p>
            <div class="separator"></div>
            <div class="popup-buttons">
                <button id="cancelLogout">Cancel</button>
                <button id="confirmLogout">Yes</button>
            </div>
        `;
        document.body.appendChild(popup);

        document.getElementById('confirmLogout').addEventListener('click', () => {
            window.location.href = logoutLink.href;
        });

        document.getElementById('cancelLogout').addEventListener('click', () => {
            popup.classList.add('fade-out');
            setTimeout(() => popup.remove(), 300);
        });
    });
  }
</script>

</body>
</html>