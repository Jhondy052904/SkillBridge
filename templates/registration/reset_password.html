{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password</title>
    <link rel="icon" type="image/png" href="{% static 'images/suitcase.png' %}">

    <link rel="stylesheet" href="{% static 'css/global-font.css' %}?v=1">
    <link rel="stylesheet" href="{% static 'css/registration/reset.css' %}?v=2">
</head>

<body>

<div class="login-page">

    <div class="login-container">
        <h2 class="login-title">Reset Your Password</h2>

        <form id="resetForm" class="login-form">
            <label>New Password</label>
            <input type="password" id="new_password" required>

            <label>Confirm Password</label>
            <input type="password" id="confirm_password" required>

            <button type="submit" class="sign-in-btn">Update Password</button>
        </form>

        <p class="back-to-login">
            <a href="{% url 'login' %}" class="back-link">Back to Login</a>
        </p>
    </div>

</div>
<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
        "https://sfgnccdbgmewovbogibo.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmZ25jY2RiZ21ld292Ym9naWJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTgxMjYsImV4cCI6MjA3NDQzNDEyNn0.ZPrGL60IPIuS9DClstiv21r_Ss6RGluj18b0ulOGnLc"
    );

    let sessionReady = false;

    // Try to extract tokens from URL hash (implicit flow) or query params (PKCE flow)
    async function initSession() {
        // Check hash fragment first (older implicit flow)
        const hash = window.location.hash.substring(1);
        const hashParams = new URLSearchParams(hash);
        const accessToken = hashParams.get("access_token");
        const refreshToken = hashParams.get("refresh_token");
        const type = hashParams.get("type");

        // Check query parameters (PKCE flow)
        const queryParams = new URLSearchParams(window.location.search);
        const code = queryParams.get("code");
        const queryType = queryParams.get("type");

        if (accessToken && refreshToken) {
            // Implicit flow with both tokens
            const { error } = await supabase.auth.setSession({
                access_token: accessToken,
                refresh_token: refreshToken
            });
            if (!error) {
                sessionReady = true;
                return;
            }
        } else if (accessToken && type === "recovery") {
            // Recovery link with just access token - exchange it
            const { data, error } = await supabase.auth.getSession();
            if (!error && data.session) {
                sessionReady = true;
                return;
            }
            // Try to verify the token
            const { error: verifyError } = await supabase.auth.verifyOtp({
                token_hash: accessToken,
                type: 'recovery'
            });
            if (!verifyError) {
                sessionReady = true;
                return;
            }
        } else if (code) {
            // PKCE flow - exchange code for session
            const { error } = await supabase.auth.exchangeCodeForSession(code);
            if (!error) {
                sessionReady = true;
                return;
            }
        }

        // Check if there's already a valid session (user clicked link and session was auto-established)
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            sessionReady = true;
            return;
        }

        // No valid token found
        document.getElementById("resetForm").innerHTML = `
            <p style="color: red; text-align: center;">
                Invalid or expired reset link.<br>
                Please request a new password reset link.
            </p>
            <a href="{% url 'forgot_password' %}" class="sign-in-btn" style="display: block; text-align: center; text-decoration: none; margin-top: 15px;">
                Request New Link
            </a>
        `;
    }

    // Initialize session on page load
    await initSession();

    document.getElementById("resetForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!sessionReady) {
            alert("Session not ready. Please use a valid reset link.");
            return;
        }

        const newPassword = document.getElementById("new_password").value;
        const confirmPassword = document.getElementById("confirm_password").value;

        if (newPassword !== confirmPassword) {
            alert("Passwords do not match!");
            return;
        }

        if (newPassword.length < 6) {
            alert("Password must be at least 6 characters long.");
            return;
        }

        const { error } = await supabase.auth.updateUser({ password: newPassword });

        if (error) {
            alert("Error resetting password: " + error.message);
        } else {
            alert("Password reset successful!");
            window.location.href = "{% url 'login' %}";
        }
    });
</script>


</body>
</html>
