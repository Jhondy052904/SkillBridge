{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard | SkillBridge</title>
    <link rel="stylesheet" href="{% static 'css/global-font.css' %}?v=1">
    <link rel="stylesheet" href="{% static 'css/registration/home.css' %}?v=6">
    <link rel="stylesheet" href="{% static 'css/registration/logout.css' %}?v=3">
</head>
<body>

<!-- ====================== NAVBAR ====================== -->
<nav class="navbar">
    <div class="nav-left">
        <a href="{% url 'home' %}" class="logo-link">
            <img src="/static/images/Skillogo.png" alt="Skill Bridge Logo" class="logo">
        </a>
    </div>

    <div class="nav-right">

        <!-- Main Navigation -->
        <a href="{% url 'home' %}"  class="active">Dashboard</a>
        <a href="{% url 'list_jobs' %}">Jobs</a>
        <a href="{% url 'list_trainings' %}">Trainings</a>

        <!-- Underline Element for Animation -->
        <div class="underline"></div>

        <!-- Separator -->
        <span class="separator">|</span>

        <!-- Profile Link -->
        <a href="{% url 'edit_profile' %}">Profile</a>

        <!-- Logout -->
        <a href="{% url 'login' %}" id="logoutLink">Logout</a>

        <!-- Notification -->
        {% include 'notification/notification.html' %}

    </div>
</nav>

<!-- ====================== MAIN ====================== -->
<main class="main-content">

    <!-- NEW: Two-column layout: left = main dashboard, right = calendar -->
    <div class="dashboard-grid">

        <!-- LEFT COLUMN (existing dashboard content) -->
        <div class="dashboard-left">
            <!-- ================= MESSAGES ================= -->
            {% if messages %}
            <div class="floating-messages">
                {% for message in messages %}
                <div class="editprofile-message {% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

        {% if user_profile %}
        <div class="profile-details">
            <p><strong>Full Name:</strong> {{ user_profile.first_name }} {% if user_profile.middle_name %}{{ user_profile.middle_name }} {% endif %}{{ user_profile.last_name }}</p>
            <p><strong>Email:</strong> {{ user_profile.email }}</p>
            <p><strong>Contact:</strong> {{ user_profile.contact_number }}</p>
            <p><strong>Address:</strong> {{ user_profile.address }}</p>
            <p><strong>Employment:</strong> {{ user_profile.employment_status }}</p>
            <p><strong>Verification:</strong> <span class="verification-status">{{ user_profile.verification_status }}</span></p>
            <p><strong>Current Status:</strong> <span class="current-status">{{ current_status }}</span></p>
            <div class="skills-dropdown">
                <button class="skills-button">View Skills â–¼</button>
                        <div class="skills-content">
                            {% for skill in user_profile.skills|split:',' %}
                        <div class="skill-item">{{ skill }}</div>
                     {% endfor %}
                </div>
            </div>
        </div>

            <a href="{% url 'edit_profile' %}" class="btn-update">Update Profile</a>
            </div>
            {% else %}
            <div class="profile-card error-card">
                <p>Profile data not found. Please contact support.</p>
                <a href="{% url 'edit_profile' %}" class="btn-update">Update Profile</a>
            </div>
            {% endif %}

            <!-- ================= REGISTERED TRAININGS ================= -->
            <section class="registered-trainings">
                <h2 class="section-title">My Registered Trainings</h2>
                <div id="trainingsList" class="trainings-list">
                    {% if registered_trainings %}
                        <ul>
                            {% for training in registered_trainings %}
                                <li class="training-item">
                                    <div class="training-info">
                                        <strong>{{ training.training_name }}</strong>
                                    </div>
                                    <span class="training-date">{{ training.date_scheduled|date:"n/j/Y" }}</span>
                                    <span class="training-status">{{ training.status }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="empty-trainings">No trainings registered yet. <a href="{% url 'list_trainings' %}" class="link-primary">Find trainings</a></p>
                    {% endif %}
                </div>
            </section>

            <!-- ================= MY CERTIFICATES ================= -->
            <section class="my-certificates">
                <h2 class="section-title">My Certificates</h2>
                <button id="uploadCertBtn" class="btn-upload-cert">+ Upload Certificate</button>
                <div id="certificatesList" class="certificates-list">
                    {% if certificates %}
                        <div class="certificates-grid">
                            {% for cert in certificates %}
                                <div class="certificate-card">
                                    <div class="certificate-info">
                                        <strong>{{ cert.training_name }}</strong>
                                    </div>
                                    <span class="training-date">{{ cert.uploaded_at|date:"n/j/Y" }}</span>
                                    <div class="certificate-actions">
                                        <a href="{{ cert.certificate_url }}" target="_blank" class="btn-view">View</a>
                                        <button class="btn-delete" data-id="{{ cert.id }}">Delete</button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="empty-certificates">No certificates uploaded yet.</p>
                    {% endif %}
                </div>
            </section>


        </div> <!-- END LEFT -->

        <!-- RIGHT COLUMN (calendar) -->
        <aside class="dashboard-right">
            <div class="calendar-panel">
                <div class="calendar-header-compact">
                    <h3 class="section-title">Calendar</h3>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <a href="{% url 'calendar' %}" class="action-btn" style="padding:8px 12px; font-size:0.9rem;">Open Calendar</a>
                        <a href="{% url 'list_trainings' %}" class="btn-update" style="padding:8px 12px; font-size:0.9rem;background:linear-gradient(135deg,#805AD5,#63B3ED);">All Events</a>
                    </div>
                </div>

                <div id="miniCalendar" style="margin-top:12px; background:rgba(255,255,255,0.98); padding:12px; border-radius:12px;">
                    <!-- FullCalendar mini will be rendered here -->
                    <div id="miniCalRoot"></div>
                </div>

                <p style="margin-top:12px;color:#718096;font-size:0.95rem;">Click a date to see jobs & trainings. For full view click "Open Calendar".</p>
            </div>
        </aside>

    </div> <!-- END GRID -->

    <!-- Upload Certificate Modal (keep your existing modal markup here unchanged) -->
    <div id="uploadCertModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>Upload Certificate</h3>
            <form id="uploadCertForm" enctype="multipart/form-data">
                {% csrf_token %}
                <label for="modalTrainingSelect">Select Training</label>
                <select id="modalTrainingSelect" name="training_id" required>
                    <option value="">-- Choose a training --</option>
                </select>

                <label for="certFile">Certificate File</label>
                <input type="file" id="certFile" name="certificates" accept=".pdf,.jpg,.jpeg" required>
                
                <button type="submit" class="btn-submit">Upload Certificate</button>
            </form>
        </div>
    </div>

</main>


<!-- Upload Certificate Modal -->
<div id="uploadCertModal" class="modal hidden">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3>Upload Certificate</h3>
        <form id="uploadCertForm" enctype="multipart/form-data">
            {% csrf_token %}
            <label for="modalTrainingSelect">Select Training</label>
            <select id="modalTrainingSelect" name="training_id" required>
                <option value="">-- Choose a training --</option>
            </select>

            <label for="certFile">Certificate File</label>
            <input type="file" id="certFile" name="certificates" accept=".pdf,.jpg,.jpeg" required>
            
            <button type="submit" class="btn-submit">Upload Certificate</button>
        </form>
    </div>
</div>

<script>

// Navbar underline animation
const menuLinks = document.querySelectorAll('.nav-right a');
const underline = document.querySelector('.nav-right .underline');

function moveUnderline(el) {
    if (!underline) return;
    const rect = el.getBoundingClientRect();
    const parentRect = el.closest('.nav-right').getBoundingClientRect();
    underline.style.width = rect.width + 'px';
    underline.style.left = (rect.left - parentRect.left) + 'px';
}

const activeLink = document.querySelector('.nav-right a.active');
if (activeLink) {
    setTimeout(() => moveUnderline(activeLink), 0);
}

menuLinks.forEach(link => {
    link.addEventListener('mouseenter', e => {
        if (e.target.tagName === 'A') moveUnderline(e.target);
    });
});

document.querySelector('.nav-right').addEventListener('mouseleave', () => {
    if (activeLink) moveUnderline(activeLink);
});

// Escape key to close
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') notifDropdown.classList.add('hidden');
});

// Logout confirmation popup
const logoutLink = document.getElementById('logoutLink');

logoutLink.addEventListener('click', function(e) {
    e.preventDefault();

    const popup = document.createElement('div');
    popup.className = 'logout-popup';
    popup.innerHTML = `
        <p>Are you sure you want to end your session?</p>
        <div class="separator"></div>
        <div class="popup-buttons">
            <button id="cancelLogout">Cancel</button>
            <button id="confirmLogout">Yes</button>
        </div>
    `;
    document.body.appendChild(popup);

    document.getElementById('confirmLogout').addEventListener('click', () => {
        window.location.href = logoutLink.href;
    });

    document.getElementById('cancelLogout').addEventListener('click', () => {
        popup.classList.add('fade-out');
        setTimeout(() => popup.remove(), 500);
    });
});

// Polling to update registered trainings
async function fetchRegisteredTrainings() {
    try {
        const resp = await fetch('/api/registered_trainings/');
        if (!resp.ok) return;
        const data = await resp.json();
        const container = document.getElementById('trainingsList');
        if (!container) return;

        if (!data || data.length === 0) {
            container.innerHTML = `<p class="empty-trainings">No trainings registered yet. <a href="{% url 'list_trainings' %}" class="link-primary">Find trainings</a></p>`;
            return;
        }

        let html = '<ul>';
        const modalSelect = document.getElementById('modalTrainingSelect');
        const selectedValue = modalSelect ? modalSelect.value : '';
        if (modalSelect) modalSelect.innerHTML = '<option value="">-- Choose a training --</option>';
        
        data.forEach(t => {
            const status = t.attendance_status || 'Pending';
            const date = t.date_scheduled ? new Date(t.date_scheduled).toLocaleDateString('en-US', {month: 'numeric', day: 'numeric', year: 'numeric'}) : '';
            html += `<li class="training-item">
                        <div class="training-info">
                            <strong>${t.training_name || 'Training'}</strong>
                        </div>
                        <span class="training-date">${date}</span>
                        <span class="training-status">${status}</span>
                    </li>`;
            if (modalSelect) {
                const opt = document.createElement('option');
                opt.value = t.training_id;
                opt.text = `${t.training_name || 'Training'} ${date ? ' - ' + date : ''}`;
                modalSelect.appendChild(opt);
            }
        });
        html += '</ul>';
        container.innerHTML = html;
        if (modalSelect && selectedValue) {
            modalSelect.value = selectedValue;
        }
    } catch (e) {
        // silent fail
    }
}

// Initial fetch and interval polling
fetchRegisteredTrainings();
setInterval(fetchRegisteredTrainings, 5000);



// Certificate upload modal
const uploadCertBtn = document.getElementById('uploadCertBtn');
const uploadCertModal = document.getElementById('uploadCertModal');
const closeModal = document.querySelector('.close-modal');
const uploadCertForm = document.getElementById('uploadCertForm');

uploadCertBtn.addEventListener('click', () => {
    uploadCertModal.classList.remove('hidden');
});

closeModal.addEventListener('click', () => {
    uploadCertModal.classList.add('hidden');
});

window.addEventListener('click', (e) => {
    if (e.target === uploadCertModal) {
        uploadCertModal.classList.add('hidden');
    }
});

uploadCertForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(uploadCertForm);

    try {
        const response = await fetch('/api/upload_certificate/', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        if (response.ok) {
            uploadCertModal.classList.add('hidden');
            location.reload();
        } else {
            const err = await response.json().catch(()=>null);
            alert('Upload failed. ' + (err && err.error ? err.error : 'Please try again.'));
        }
    } catch (error) {
        alert('An error occurred. Please try again.');
    }
});

// Delete certificate
document.addEventListener('click', async (e) => {
    if (e.target.classList.contains('btn-delete')) {
        e.preventDefault();
        const certId = e.target.getAttribute('data-id');
        if (!confirm('Are you sure you want to delete this certificate?')) return;

        try {
            const response = await fetch('/api/delete_certificate/', {
                method: 'POST',
                body: new URLSearchParams({ cert_id: certId }),
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            if (response.ok) {
                const certCard = e.target.closest('.certificate-card');
                if (certCard) certCard.remove();
                
                const grid = document.querySelector('.certificates-grid');
                if (grid && grid.children.length === 0) {
                    grid.remove();
                    document.querySelector('#certificatesList').innerHTML = '<p class="empty-certificates">No certificates uploaded yet.</p>';
                }
            } else {
                const err = await response.json().catch(()=>null);
                alert('Delete failed. ' + (err && err.error ? err.error : 'Please try again.'));
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
        }
    }
});

</script>
<!-- FullCalendar CDN (only once) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // initialize a compact month view inside #miniCalRoot
    const el = document.getElementById('miniCalRoot');
    if (!el) return;

    const miniCal = new FullCalendar.Calendar(el, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: '',
            center: 'title',
            right: ''
        },
        height: 300,
        events: {
            url: "{% url 'calendar_events' %}",
            method: 'GET',
            failure: function() {
                // keep it quiet and show tiny text instead of alert
                console.warn('Calendar load failed.');
            }
        },
        eventDisplay: 'block',
        dayMaxEventRows: 2, // show up to 2 events per day in compact view
        views: {
            dayGridMonth: {
                dayMaxEventRows: 2
            }
        },
        eventClick: function(info) {
            // show small quick modal (re-use your message style or use alert)
            const evt = info.event;
            const raw = evt.extendedProps.raw || {};
            const title = evt.title;
            const date = evt.start ? evt.start.toLocaleDateString() : '';
            const desc = raw.description || raw.Description || raw.training_name || raw.Title || '';
            // Use a simple browser modal for quick view
            alert(title + "\n" + date + "\n\n" + desc);
        }
    });

    miniCal.render();

    // OPTIONAL: refresh events every 60s to show new posts
    // setInterval(() => miniCal.refetchEvents(), 60000);
});
</script>

</body>
</html>