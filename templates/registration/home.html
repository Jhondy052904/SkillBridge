{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard | SkillBridge</title>
    <link rel="stylesheet" href="{% static 'css/registration/home.css' %}?v=3">
    <link rel="stylesheet" href="{% static 'css/registration/logout.css' %}?v=3">
</head>
<body>

<!-- ====================== NAVBAR ====================== -->
<nav class="navbar">
  <div class="nav-left">
    <a href="#" class="logo-link">
      <img src="/static/images/Skillogo.png" alt="Skill Bridge Logo" class="logo">
    </a>
  </div>
  <div class="nav-right">
    <a href="{% url 'home' %}" class="active">Dashboard</a>
    <a href="{% url 'list_jobs' %}">Jobs</a>
    <a href="{% url 'list_trainings' %}">Trainings</a>
    <div class="underline"></div>
    <a>|</a>
    <a href="{% url 'edit_profile' %}">Profile</a>
    <a href="{% url 'login' %}" id="logoutLink">Logout</a>

  </div>
</nav>

<!-- ====================== MAIN ====================== -->
<main class="main-content">

    <!-- HEADER -->
    <header class="header">
        <h1 class="header-title">Welcome, {{ user.username }}!</h1>

        <!-- Notification Bell -->
        <div class="notifications">
            <button onclick="toggleNotifDropdown()" id="notifBtn" class="notif-btn">
                ðŸ””
                {% if notifications %}
                    <span class="notif-indicator"></span>
                {% endif %}
            </button>

            <!-- DROPDOWN -->
            <div id="notifDropdown" class="notif-dropdown hidden">
                {% if notifications %}
                    {% for notif in notifications %}
                    <div onclick="window.location.href='{{ notif.link_url }}'" class="notif-item">
                        <p class="notif-message">{{ notif.message }}</p>
                        <small class="notif-date">{{ notif.created_at|date:"M d, Y h:i A" }}</small>
                    </div>
                    {% endfor %}
                    <form method="POST" action="{% url 'clear_notifications' %}">
                        {% csrf_token %}
                        <button type="submit" class="notif-clear-btn">Clear All</button>
                    </form>
                {% else %}
                    <p class="notif-empty">No notifications.</p>
                {% endif %}
            </div>
        </div>
    </header>

<!-- MESSAGES -->
{% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="message {% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% else %}info{% endif %}">
        <span class="message-text">{{ message }}</span>
    </div>
    {% endfor %}
</div>
{% endif %}


    <!-- ================= PROFILE CARD ================= -->
    {% if user_profile %} 
    <div class="profile-card">   
        <div class="profile-header">
            <img src="{% static 'images/snoopy.png' %}" class="profile-img" alt="Profile Image">
            <div class="profile-info">
                <h3 class="profile-name">{{ user_profile.first_name }} {{ user_profile.last_name }}</h3>
                <p class="profile-role"><strong>Role:</strong> Resident</p>
            </div>
        </div>

        <div class="profile-details">
            <p><strong>Email:</strong> {{ user_profile.email }}</p>
            <p><strong>Contact:</strong> {{ user_profile.contact_number }}</p>
            <p><strong>Address:</strong> {{ user_profile.address }}</p>
            <p><strong>Employment:</strong> {{ user_profile.employment_status }}</p>
            <p><strong>Verification:</strong> <span class="verification-status">{{ user_profile.verification_status }}</span></p>
            <p><strong>Skills:</strong> <span class="skills">{{ user_profile.skills }}</span></p>
        </div>

        <a href="{% url 'edit_profile' %}" class="btn-update">Update Profile</a>
    </div>
    {% else %}
    <div class="profile-card error-card">
        <p>Profile data not found. Please contact support.</p>
        <a href="{% url 'edit_profile' %}" class="btn-update">Update Profile</a>
    </div>
    {% endif %}

    <!-- ================= APPLIED JOBS ================= -->
    <section class="applied-jobs">
        <h2 class="section-title">My Applied Jobs</h2>

        <div class="table-container">
            <table class="jobs-table">
                <thead>
                    <tr>
                        <th>Job Title</th>
                        <th>Status</th>
                        <th>Date Applied</th>
                    </tr>
                </thead>
                <tbody>
                    {% if applied_jobs %}
                        {% for app in applied_jobs %}
                        <tr>
                            <td>{{ app.job.title }}</td>
                            <td><span class="status {{ app.application_status|lower }}">{{ app.application_status }}</span></td>
                            <td>{{ app.date_applied|date:"M d, Y" }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="3" class="empty-table">No jobs applied yet.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </section>

    <!-- ================= REGISTERED TRAININGS ================= -->
    <section class="registered-trainings">
        <h2 class="section-title">My Registered Trainings</h2>

        <div class="trainings-list">
            {% if registered_trainings %}
                <ul>
                    {% for training in registered_trainings %}
                        <li class="training-item">
                            <strong>{{ training.training_name }}</strong>
                            <span class="training-status">{{ training.status }}</span>
                            <br><span class="training-date">{{ training.date_scheduled|date:"M d, Y" }}</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="empty-trainings">No trainings registered yet. <a href="{% url 'list_trainings' %}" class="link-primary">Find trainings</a></p>
            {% endif %}
        </div>
    </section>

    <!-- ================= QUICK ACTIONS ================= -->
    <section class="quick-actions">
        <h2 class="section-title">Quick Actions</h2>
        <div class="actions-grid">
            <a href="{% url 'list_jobs' %}" class="action-btn jobs-btn">Browse Jobs</a>
            <a href="{% url 'list_trainings' %}" class="action-btn trainings-btn">Find Trainings</a>
        </div>
    </section>

</main>

<script>
const notifBtn = document.getElementById('notifBtn');
const notifDropdown = document.getElementById('notifDropdown');

function toggleNotifDropdown() {
    notifDropdown.classList.toggle('hidden');
}

// Click outside to close
document.addEventListener('click', (e) => {
    if (!notifDropdown.contains(e.target) && !notifBtn.contains(e.target)) {
        notifDropdown.classList.add('hidden');
    }
});

// Escape key to close
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') notifDropdown.classList.add('hidden');
});

const menuLinks = document.querySelectorAll('.nav-right a');
const underline = document.querySelector('.nav-right .underline');

function moveUnderline(el) {
    const rect = el.getBoundingClientRect();
    const parentRect = el.closest('.nav-right').getBoundingClientRect();
    underline.style.width = rect.width + 'px';
    underline.style.left = (rect.left - parentRect.left) + 'px';
}

// Initialize on active link
const activeLink = document.querySelector('.nav-right a.active');
if (activeLink) moveUnderline(activeLink);

// Hover effect
menuLinks.forEach(link => {
    link.addEventListener('mouseenter', e => moveUnderline(e.target));
});

// Reset to active link on mouse leave
document.querySelector('.nav-right').addEventListener('mouseleave', () => {
    if (activeLink) moveUnderline(activeLink);
});

// Logout confirmation popup
const logoutLink = document.getElementById('logoutLink');

logoutLink.addEventListener('click', function(e) {
    e.preventDefault(); // prevent default navigation

    // Create popup container
    const popup = document.createElement('div');
    popup.className = 'logout-popup';
    popup.innerHTML = `
        <p>Are you sure you want to end your session?</p>
        <div class="separator"></div>
        <div class="popup-buttons">
            <button id="cancelLogout">Cancel</button>
            <button id="confirmLogout">Yes</button>
        </div>
    `;
    document.body.appendChild(popup);

    // Confirm button: logs out
    document.getElementById('confirmLogout').addEventListener('click', () => {
        window.location.href = logoutLink.href; // proceed to logout
    });

    // Cancel button: fade out popup
    document.getElementById('cancelLogout').addEventListener('click', () => {
        popup.classList.add('fade-out'); // trigger fade-out CSS
        setTimeout(() => popup.remove(), 500); // remove after animation
    });
});

//Welcome message
document.addEventListener('DOMContentLoaded', () => {
    const messages = document.querySelectorAll('.messages .message');

    messages.forEach(msg => {
        // Add close button
        const closeBtn = document.createElement('span');
        closeBtn.className = 'close-msg';
        closeBtn.innerHTML = '&times;';
        msg.appendChild(closeBtn);

        closeBtn.addEventListener('click', () => msg.remove());

        // Auto-fade after 5 seconds
        setTimeout(() => {
            msg.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            msg.style.opacity = '0';
            msg.style.transform = 'translateX(50px)';
            msg.addEventListener('transitionend', () => msg.remove(), { once: true });
        }, 5000);
    });
});


</script>

</body>
</html>
