{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard | SkillBridge</title>
    <link rel="stylesheet" href="{% static 'css/registration/home.css' %}?v=6">
    <link rel="stylesheet" href="{% static 'css/registration/logout.css' %}?v=3">
</head>
<body>

<!-- ====================== NAVBAR ====================== -->
<nav class="navbar">
    <div class="nav-left">
        <a href="#" class="logo-link">
            <img src="/static/images/Skillogo.png" alt="Skill Bridge Logo" class="logo">
        </a>
    </div>
    <div class="nav-right">
        <a href="{% url 'home' %}" class="active">Dashboard</a>
        <a href="{% url 'list_jobs' %}">Jobs</a>
        <a href="{% url 'list_trainings' %}">Trainings</a>
        <div class="underline"></div>
        <a>|</a>
        <a href="{% url 'edit_profile' %}">Profile</a>
        
        <!-- Notifications as Text Button -->
        <div class="notifications">
            <button onclick="toggleNotifDropdown()" id="notifBtn" class="notif-btn">
                Notifications
                {% if notifications %}
                    <span class="notif-indicator"></span>
                {% endif %}
            </button>

            <!-- DROPDOWN -->
            <div id="notifDropdown" class="notif-dropdown hidden">
                {% if notifications %}
                    {% for notif in notifications %}
                    <div onclick="window.location.href='{{ notif.link_url }}'" class="notif-item">
                        <p class="notif-message">{{ notif.message }}</p>
                        <small class="notif-date">{{ notif.created_at|date:"M d, Y h:i A" }}</small>
                    </div>
                    {% endfor %}
                    <form method="POST" action="{% url 'clear_notifications' %}">
                        {% csrf_token %}
                        <button type="submit" class="notif-clear-btn">Clear All</button>
                    </form>
                {% else %}
                    <p class="notif-empty">No notifications.</p>
                {% endif %}
            </div>
        </div>
        
        <a href="{% url 'login' %}" id="logoutLink">Logout</a>
    </div>
</nav>

<!-- ====================== MAIN ====================== -->
<main class="main-content">

    <!-- MESSAGES -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="message {% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% else %}info{% endif %}">
            <span class="message-text">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ================= PROFILE CARD ================= -->
    {% if user_profile %} 
    <div class="profile-card">   
        <div class="profile-header">
            <img src="{% static 'images/snoopy.png' %}" class="profile-img" alt="Profile Image">
            <div class="profile-info">
                <h3 class="profile-name">{{ user_profile.first_name }} {{ user_profile.last_name }}</h3>
                <p class="profile-role"><strong>Role:</strong> Resident</p>
            </div>
        </div>

        <div class="profile-details">
            <p><strong>Email:</strong> {{ user_profile.email }}</p>
            <p><strong>Contact:</strong> {{ user_profile.contact_number }}</p>
            <p><strong>Address:</strong> {{ user_profile.address }}</p>
            <p><strong>Employment:</strong> {{ user_profile.employment_status }}</p>
            <p><strong>Verification:</strong> <span class="verification-status">{{ user_profile.verification_status }}</span></p>
            <p><strong>Current Status:</strong> <span class="current-status">{{ current_status }}</span></p>
            <p><strong>Skills:</strong> <span class="skills">{{ user_profile.skills }}</span></p>
        </div>

        <a href="{% url 'edit_profile' %}" class="btn-update">Update Profile</a>
    </div>
    {% else %}
    <div class="profile-card error-card">
        <p>Profile data not found. Please contact support.</p>
        <a href="{% url 'edit_profile' %}" class="btn-update">Update Profile</a>
    </div>
    {% endif %}

    <!-- ================= REGISTERED TRAININGS ================= -->
    <section class="registered-trainings">
        <h2 class="section-title">My Registered Trainings</h2>

        <div id="trainingsList" class="trainings-list">
            {% if registered_trainings %}
                <ul>
                    {% for training in registered_trainings %}
                        <li class="training-item">
                            <div class="training-info">
                                <strong>{{ training.training_name }}</strong>
                            </div>
                            <span class="training-date">{{ training.date_scheduled|date:"n/j/Y" }}</span>
                            <span class="training-status">{{ training.status }}</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="empty-trainings">No trainings registered yet. <a href="{% url 'list_trainings' %}" class="link-primary">Find trainings</a></p>
            {% endif %}
        </div>
    </section>

    <!-- ================= MY CERTIFICATES ================= -->
    <section class="my-certificates">
        <h2 class="section-title">My Certificates</h2>

        <button id="uploadCertBtn" class="btn-upload-cert">+ Upload Certificate</button>

        <div id="certificatesList" class="certificates-list">
            {% if certificates %}
                <div class="certificates-grid">
                    {% for cert in certificates %}
                        <div class="certificate-card">
                            <div class="certificate-info">
                                <strong>{{ cert.training_name }}</strong>
                            </div>
                            <span class="training-date">{{ cert.uploaded_at|date:"n/j/Y" }}</span>
                            <div class="certificate-actions">
                                <a href="{{ cert.certificate_url }}" target="_blank" class="btn-view">View</a>
                                <button class="btn-delete" data-id="{{ cert.id }}">Delete</button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="empty-certificates">No certificates uploaded yet.</p>
            {% endif %}
        </div>
    </section>

    <!-- ================= QUICK ACTIONS ================= -->
    <section class="quick-actions">
        <h2 class="section-title">Quick Actions</h2>
        <div class="actions-grid">
            <a href="{% url 'list_jobs' %}" class="action-btn jobs-btn">Browse Jobs</a>
            <a href="{% url 'list_trainings' %}" class="action-btn trainings-btn">Find Trainings</a>
        </div>
    </section>

</main>

<!-- Upload Certificate Modal -->
<div id="uploadCertModal" class="modal hidden">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3>Upload Certificate</h3>
        <form id="uploadCertForm" enctype="multipart/form-data">
            {% csrf_token %}
            <label for="modalTrainingSelect">Select Training</label>
            <select id="modalTrainingSelect" name="training_id" required>
                <option value="">-- Choose a training --</option>
            </select>

            <label for="certFile">Certificate File</label>
            <input type="file" id="certFile" name="certificates" accept=".pdf,.jpg,.jpeg" required>
            
            <button type="submit" class="btn-submit">Upload Certificate</button>
        </form>
    </div>
</div>

<script>
const notifBtn = document.getElementById('notifBtn');
const notifDropdown = document.getElementById('notifDropdown');

function toggleNotifDropdown() {
    notifDropdown.classList.toggle('hidden');
}

// Click outside to close
document.addEventListener('click', (e) => {
    if (!notifDropdown.contains(e.target) && !notifBtn.contains(e.target)) {
        notifDropdown.classList.add('hidden');
    }
});

// Escape key to close
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') notifDropdown.classList.add('hidden');
});

// Logout confirmation popup
const logoutLink = document.getElementById('logoutLink');

logoutLink.addEventListener('click', function(e) {
    e.preventDefault();

    const popup = document.createElement('div');
    popup.className = 'logout-popup';
    popup.innerHTML = `
        <p>Are you sure you want to end your session?</p>
        <div class="separator"></div>
        <div class="popup-buttons">
            <button id="cancelLogout">Cancel</button>
            <button id="confirmLogout">Yes</button>
        </div>
    `;
    document.body.appendChild(popup);

    document.getElementById('confirmLogout').addEventListener('click', () => {
        window.location.href = logoutLink.href;
    });

    document.getElementById('cancelLogout').addEventListener('click', () => {
        popup.classList.add('fade-out');
        setTimeout(() => popup.remove(), 500);
    });
});

// Polling to update registered trainings
async function fetchRegisteredTrainings() {
    try {
        const resp = await fetch('/api/registered_trainings/');
        if (!resp.ok) return;
        const data = await resp.json();
        const container = document.getElementById('trainingsList');
        if (!container) return;

        if (!data || data.length === 0) {
            container.innerHTML = `<p class="empty-trainings">No trainings registered yet. <a href="{% url 'list_trainings' %}" class="link-primary">Find trainings</a></p>`;
            return;
        }

        let html = '<ul>';
        const modalSelect = document.getElementById('modalTrainingSelect');
        const selectedValue = modalSelect ? modalSelect.value : '';
        if (modalSelect) modalSelect.innerHTML = '<option value="">-- Choose a training --</option>';
        
        data.forEach(t => {
            const status = t.attendance_status || 'Pending';
            const date = t.date_scheduled ? new Date(t.date_scheduled).toLocaleDateString('en-US', {month: 'numeric', day: 'numeric', year: 'numeric'}) : '';
            html += `<li class="training-item">
                        <div class="training-info">
                            <strong>${t.training_name || 'Training'}</strong>
                        </div>
                        <span class="training-date">${date}</span>
                        <span class="training-status">${status}</span>
                    </li>`;
            if (modalSelect) {
                const opt = document.createElement('option');
                opt.value = t.training_id;
                opt.text = `${t.training_name || 'Training'} ${date ? ' - ' + date : ''}`;
                modalSelect.appendChild(opt);
            }
        });
        html += '</ul>';
        container.innerHTML = html;
        if (modalSelect && selectedValue) {
            modalSelect.value = selectedValue;
        }
    } catch (e) {
        // silent fail
    }
}

// Initial fetch and interval polling
fetchRegisteredTrainings();
setInterval(fetchRegisteredTrainings, 5000);

// Welcome message
document.addEventListener('DOMContentLoaded', () => {
    const messages = document.querySelectorAll('.messages .message');

    messages.forEach(msg => {
        const closeBtn = document.createElement('span');
        closeBtn.className = 'close-msg';
        closeBtn.innerHTML = '&times;';
        msg.appendChild(closeBtn);

        closeBtn.addEventListener('click', () => msg.remove());

        setTimeout(() => {
            msg.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            msg.style.opacity = '0';
            msg.style.transform = 'translateX(50px)';
            msg.addEventListener('transitionend', () => msg.remove(), { once: true });
        }, 5000);
    });
});

// Certificate upload modal
const uploadCertBtn = document.getElementById('uploadCertBtn');
const uploadCertModal = document.getElementById('uploadCertModal');
const closeModal = document.querySelector('.close-modal');
const uploadCertForm = document.getElementById('uploadCertForm');

uploadCertBtn.addEventListener('click', () => {
    uploadCertModal.classList.remove('hidden');
});

closeModal.addEventListener('click', () => {
    uploadCertModal.classList.add('hidden');
});

window.addEventListener('click', (e) => {
    if (e.target === uploadCertModal) {
        uploadCertModal.classList.add('hidden');
    }
});

uploadCertForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(uploadCertForm);

    try {
        const response = await fetch('/api/upload_certificate/', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        if (response.ok) {
            uploadCertModal.classList.add('hidden');
            location.reload();
        } else {
            const err = await response.json().catch(()=>null);
            alert('Upload failed. ' + (err && err.error ? err.error : 'Please try again.'));
        }
    } catch (error) {
        alert('An error occurred. Please try again.');
    }
});

// Delete certificate
document.addEventListener('click', async (e) => {
    if (e.target.classList.contains('btn-delete')) {
        e.preventDefault();
        const certId = e.target.getAttribute('data-id');
        if (!confirm('Are you sure you want to delete this certificate?')) return;

        try {
            const response = await fetch('/api/delete_certificate/', {
                method: 'POST',
                body: new URLSearchParams({ cert_id: certId }),
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            if (response.ok) {
                const certCard = e.target.closest('.certificate-card');
                if (certCard) certCard.remove();
                
                const grid = document.querySelector('.certificates-grid');
                if (grid && grid.children.length === 0) {
                    grid.remove();
                    document.querySelector('#certificatesList').innerHTML = '<p class="empty-certificates">No certificates uploaded yet.</p>';
                }
            } else {
                const err = await response.json().catch(()=>null);
                alert('Delete failed. ' + (err && err.error ? err.error : 'Please try again.'));
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
        }
    }
});
</script>

</body>
</html>